---
title: "CFB Game Predictive Model"
author: ""
date: "2024-10-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


### Install Packages
```{r}
library(tidyverse)
library(ggplot2)
library(rsample)
library(mice)
library(fastDummies)
library(xgboost)
library(Metrics)
library(caret)
library(httr2)
library(readr)
library(cfbfastR)
```

```{r}
# load in helper functions
source("cfb_app_helpers.R")
```


<br>


## Load Pre-Processed cfbfastR Data

```{r, warning=FALSE}

# this week (really season's) prepped data
cfb_data_this_week = read.csv("this_week_prepped_data.csv")[-1]

# old model data
cfb_data_old = read.csv(gzfile("current_data/21to24_prepped_data.csv.gz"))
# get rid of cols not in new data
cfb_data_old = cfb_data_old %>% select(-c(grep("rol_off", names(cfb_data_old)), grep("rol_def", names(cfb_data_old))))

# combine the two
cfb_data = bind_rows(cfb_data_old, cfb_data_this_week)


```


```{r}

# Pre-processing

# current week/season
current_week = max(cfb_data_this_week$week)
current_season = max(cfb_data_this_week$season)
# CANGE THIS IF YOURE RUNNING FOR MULTIPLE WEEKS
wk_range = c(current_week)


# df with only rows with both fbs team (fcs data incomplete, easier to exclude these)
# later weeks to let stats accumulate, data before 2015 incomplete 
fbs_only = cfb_data %>% 
  filter(t1_division == "fbs" & t2_division == "fbs") %>% 
  filter(season > 2014)%>% 
  select(-c(t1_division, t2_division)) %>% 
  mutate(conference_game = ifelse(conference_game, 1, 0))
  

# treat NAs, add lag as the stat if there isn't one for a given week
# filter out games that are incomplete, unless for this week
model_prepped_orig = fbs_only %>% 
  filter(((completed == TRUE | (season == current_season & week == current_week)) & !is.na(precipitation_code)) | (week == current_week & season == current_season),
         ) %>% # get rid of non-played games
  
  # replace NAs from pbp with lag for each team/season window, both for t1 and t2
  # best estimate of these stats, if available
  group_by(season, t1_team) %>%
  arrange(t1_team, season, week) %>% 
  mutate(across(starts_with("t1_rol"), ~ ifelse(is.na(.), lag(.), .))) %>% 
  ungroup() %>% 
  group_by(season, t2_team) %>% 
  arrange(t2_team, season, week) %>% 
  mutate(across(starts_with("t2_rol"), ~ ifelse(is.na(.), lag(.), .))) %>% 
  ungroup() %>% 
  select(-c(rol_win_l1, "rol_loss_l1")) %>% 
  
  
  # filter week >3, only use those #######################################################CHANGE THIS##################################
  filter(week > 3 | (season == 2025 & week>1))%>% 
  
  # create outcome vars
  mutate(actual_t1_cover = ifelse(t1_book_spread*-1<t1_point_diff, 1, 0),
         actual_over = ifelse(total_points>book_over_under,1,0))





```


<br>

### Pre-Model Pre-Processing


```{r}

# dummy cols 
model_prepped_dummy = model_prepped_orig %>% 
  rename(pc = precipitation_code) %>% 
  dummy_cols('pc') %>% 
  select(-pc)


# rearrange col order (makes easier when looking at predictions later)
move_cols = c("pc_no_rain", "pc_light_rain", "pc_moderate_rain", "pc_heavy_rain", "week","t2_home", "conference_game", "season", "t1_point_diff", "t1_win", "total_points", "t1_points", "t2_points", "game_id", "t1_team", "t2_team", "t1_conference", "t2_conference", "completed", "t1_moneyline", "t2_moneyline", "actual_t1_cover", "actual_over")

model_prepped_moved = model_prepped_dummy[, c(setdiff(names(model_prepped_dummy), move_cols), move_cols)]


# get rid of weather cols for now (will be hard to implement in real time)
model_prepped_moved = model_prepped_moved %>% select(-c(grep("rain", names(model_prepped_moved)))) 
model_prepped_moved = model_prepped_moved %>% select(-c(wind_speed, temperature, humidity))

```



### Omit Remaining NA Rows
```{r}

# NA omitted df (not needed anymore due to XGBoost handling NAs)
model_prepped_omit = model_prepped_moved


# this week's matchups (save for app)
model_prepped_this_week = model_prepped_omit %>% filter(season == current_season & week == current_week)
write.csv(model_prepped_this_week, "model_prepped_this_week.csv")



```


<br> 


## Run Models

### Cover Probability


```{r}

# tuned parameters
params = list(eta = .03,
              max.depth = 4, 
              min_child_weight = 4, 
              gamma = .05, 
              subsample = .7, 
              colsample_bytree = .8,
              
              
              nrounds = 204 ,
              early_stopping_rounds = 15, 
              
              verbose = 0, 
              nthread = 8,
              
              objective = "binary:logistic",
              eval_metric = "error")

# parameters for var selection
params_tune = list(eta = .065,
              max.depth = 4, 
              min_child_weight = 4, 
              gamma = .05, 
              subsample = .7, 
              colsample_bytree = .8,
              
              
              nrounds = 68 , 
              early_stopping_rounds = 15, 
              
              verbose = 0, 
              nthread = 8,
              
              objective = "binary:logistic",
              eval_metric = "error")

# the cp model
cp_model = model_func_single_year("actual_t1_cover", model_prepped_omit, 6, current_season, wk_range, params, params_tune)


# write out
write.csv(cp_model, "current_data/cp_model_most_recent.csv")
write.csv(cp_model, paste0("results_saves/cp_model", current_season, min(wk_range), "to", max(wk_range), ".csv"))
#cp_model = read.csv("cp_model_21to24.csv")



```


```{r}


# Record betting accuracy
pred_dat_final_cp = cp_model


# modify col names and calculate predicted wp
pred_dat_final_cp = pred_dat_final_cp %>% 
  rename(pred_t1_cp = preds,
         actual_t1_cover = oc_var)




# id mins and maxs for flipping
pred_dat_final_cp$id_max = pmax(pred_dat_final_cp$t1_team, pred_dat_final_cp$t2_team)
pred_dat_final_cp$id_min = pmin(pred_dat_final_cp$t1_team, pred_dat_final_cp$t2_team)




# flip duplicate games and aggregate
merge_preds_cp = pred_dat_final_cp %>% 
  mutate(pred_t1_cp = ifelse(t1_team == id_max,pred_t1_cp, 
                                     1 - pred_t1_cp)) %>% 
  group_by(game_id) %>% 
  summarise(pred_t1_cp = mean(pred_t1_cp))

pred_dat_final_cp = pred_dat_final_cp %>% 
  filter(t1_team == id_max) %>% 
  select(-c(pred_t1_cp)) %>% 
  left_join(merge_preds_cp, by = c("game_id"))%>% 
  mutate(pred_t1_cp = round(pred_t1_cp, 4),
         pred_t1_cover = ifelse(pred_t1_cp > .5, 1, 0)) %>% 
  select(-c(id_min, id_max))



# write out
write.csv(pred_dat_final_cp, "current_data/pred_dat_final_cp_most_recent.csv")


```


<br>

### Win Probability

```{r}

# tuned parameters
params = list(eta = .03,
              max.depth = 4, # Set max depth
              min_child_weight = 6, # Set minimum number of samples in node to split
              gamma = .04, # Set minimum loss reduction for split
              subsample = .8, # Set proportion of training data to use in tree
              colsample_bytree = .9,
              
              
              nrounds = 185 , # Set number of rounds
              early_stopping_rounds = 15, # Set number of rounds to stop at if there is no improvement)
              
              verbose = 0, # 1 - Prints out fit
              nthread = 8,
              
              objective = "binary:logistic",
              eval_metric = "error")

# final params var select
params_tune = list(eta = .06,
              max.depth = 4, # Set max depth
              min_child_weight = 6, # Set minimum number of samples in node to split
              gamma = .04, # Set minimum loss reduction for split
              subsample = .8, # Set proportion of training data to use in tree
              colsample_bytree = .9,
              
              
              nrounds = 61 , # Set number of rounds
              early_stopping_rounds = 15, # Set number of rounds to stop at if there is no improvement)
              
              verbose = 0, # 1 - Prints out fit
              nthread = 8,
              
              objective = "binary:logistic",
              eval_metric = "error")

# the wp model
wp_model = model_func_single_year("t1_win", model_prepped_omit, 6, current_season, wk_range, params, params_tune)

# write out
write.csv(wp_model, "current_data/wp_model_most_recent.csv")
write.csv(wp_model, paste0("results_saves/wp_model", current_season, min(wk_range), "to", max(wk_range), ".csv"))

```

```{r}


# Record betting accuracy
pred_dat_final_wp = wp_model


# modify col names and calculate predicted wp
pred_dat_final_wp = pred_dat_final_wp %>% 
  rename(pred_t1_wp = preds,
         actual_t1_win = oc_var)




# id mins and maxs for flipping
pred_dat_final_wp$id_max = pmax(pred_dat_final_wp$t1_team, pred_dat_final_wp$t2_team)
pred_dat_final_wp$id_min = pmin(pred_dat_final_wp$t1_team, pred_dat_final_wp$t2_team)




# flip duplicate games and aggregate
merge_preds_wp = pred_dat_final_wp %>% 
  mutate(pred_t1_wp = ifelse(t1_team == id_max,pred_t1_wp, 
                                     1 - pred_t1_wp)) %>% 
  group_by(game_id) %>% 
  summarise(pred_t1_wp = mean(pred_t1_wp))

pred_dat_final_wp = pred_dat_final_wp %>% 
  filter(t1_team == id_max) %>% 
  select(-c(pred_t1_wp)) %>% 
  left_join(merge_preds_wp, by = c("game_id"))%>% 
  mutate(pred_t1_wp = round(pred_t1_wp, 4),
         pred_t1_win = ifelse(pred_t1_wp > .5, 1, 0)) %>% 
  select(-c(id_min, id_max))


# write out
write.csv(pred_dat_final_wp, "current_data/pred_dat_final_wp_most_recent.csv")


```

<br>

### Total Points Model


```{r}

# tuned parameters
parameters = list(
              eta = 0.05, 
              
              max.depth = 4, 
              min_child_weight = 5, 
              gamma = .04, 
              subsample = .8, 
              colsample_bytree = .9,    
              
              
              nrounds = 149 , 
              early_stopping_rounds = 15, 
              
              verbose = 0, 
              nthread = 8,
              
              objective = "binary:logistic",
              eval_metric = "error")

# parameters for var selection
params_tune = list(
              eta = 0.06, 
              
              max.depth = 4, 
              min_child_weight = 5, 
              gamma = .04, 
              subsample = .8, 
              colsample_bytree = .9,    
              
              
              nrounds = 69 , 
              early_stopping_rounds = 15, 
              
              verbose = 0, 
              nthread = 8,
              
              objective = "binary:logistic",
              eval_metric = "error")

# the wp model
op_model = model_func_single_year("actual_over", model_prepped_omit, 6, current_season, wk_range, parameters, params_tune)

# write out
write.csv(op_model, "current_data/op_model_most_recent.csv")
write.csv(op_model, paste0("results_saves/op_model", current_season, min(wk_range), "to", max(wk_range), ".csv"))


```

```{r}

# Record betting accuracy
pred_dat_final_op = op_model


# modify col names and calculate predicted wp
pred_dat_final_op = pred_dat_final_op %>% 
  rename(pred_op = preds,
         actual_over = oc_var)




# id mins and maxs for flipping
pred_dat_final_op$id_max = pmax(pred_dat_final_op$t1_team, pred_dat_final_op$t2_team)
pred_dat_final_op$id_min = pmin(pred_dat_final_op$t1_team, pred_dat_final_op$t2_team)




# flip duplicate games and aggregate
merge_preds_op = pred_dat_final_op %>% 
  group_by(game_id) %>% 
  summarise(pred_op = mean(pred_op))

pred_dat_final_op = pred_dat_final_op %>% 
  filter(t1_team == id_max) %>% 
  select(-c(pred_op)) %>% 
  left_join(merge_preds_op, by = c("game_id"))%>% 
  mutate(pred_op = round(pred_op, 4),
         pred_over = ifelse(pred_op > .5, 1, 0)) %>% 
  select(-c(id_min, id_max, t1_team, t2_team))


# write out
write.csv(pred_dat_final_op, "current_data/pred_dat_final_op_most_recent.csv")


```



<br>

## Compute Profitability

### Join all predictions

```{r}
# read in preds dfs
pred_dat_final_cp = read.csv("current_data/pred_dat_final_cp_most_recent.csv")[,-1]
pred_dat_final_op = read.csv("current_data/pred_dat_final_op_most_recent.csv")[,-1]
pred_dat_final_wp = read.csv("current_data/pred_dat_final_wp_most_recent.csv")[,-1]


# select cols to add back
info_lookup = model_prepped_orig %>% select(t1_book_spread, book_over_under, t1_team, t2_team, game_id, week, season, t1_home, neutral_site, t1_conference, t2_conference, t1_moneyline, t2_moneyline)


# join to all preds
pred_dat_final_pre = pred_dat_final_cp %>% 
  left_join(pred_dat_final_wp, by = c("t1_team", "t2_team", "game_id")) %>% 
  left_join(pred_dat_final_op, by = c("game_id")) %>% 
  left_join(info_lookup, by = c("t1_team", "t2_team", "game_id")) 

```

```{r}

# flip  all data (t1 becomes t2 and vice versa)
pred_dat_final_flip = pred_dat_final_pre %>% 
  mutate(pred_t1_cover = (1-pred_t1_cover),
         actual_t1_cover = (1-actual_t1_cover),
         pred_t1_cp = 1-pred_t1_cp,
         actual_t1_win = ifelse(actual_t1_win==1,0,1),
         pred_t1_win = ifelse(pred_t1_win==1,0,1),
         pred_t1_wp = 1-pred_t1_wp,
         t1_book_spread = t1_book_spread*-1,
         t1_home = ifelse(t1_home==1,0,ifelse(neutral_site == 1, 0,1))
         ) %>% 
   mutate(
    across(
      .cols = c("t1_team", "t2_team", "t1_conference", "t2_conference", "t1_moneyline", "t2_moneyline"),
      .fns = ~ .x, .names = "{.col}_copy"
    )
  ) %>%
  mutate(
    t1_conference = t2_conference_copy,
    t2_conference = t1_conference_copy,
    t1_team = t2_team_copy,
    t2_team = t1_team_copy,
    t2_moneyline = t1_moneyline_copy,
    t1_moneyline = t2_moneyline_copy
  ) %>%
  select(-ends_with("_copy"))


# bind flipped and original together (should be 4 rows for each game now)
pred_dat_final_all = bind_rows(pred_dat_final_pre, pred_dat_final_flip) 

# id mins and maxs
pred_dat_final_all$id_max = pmax(pred_dat_final_all$t1_team, pred_dat_final_all$t2_team)
pred_dat_final_all$id_min = pmin(pred_dat_final_all$t1_team, pred_dat_final_all$t2_team)

# filter out half of those games, just keeping when t1 = id_max
pred_dat_final_all  = pred_dat_final_all %>% filter(t1_home | (neutral_site == 1 & id_max == t1_team)) %>%
  select(-c(id_max, id_min))


```


### Calculate Winnings

```{r}

# get rid of current week, wont have game results bc hasnt played yet
winnings_calc = pred_dat_final_all  %>% filter(week!=current_week) %>% 
  
  
  ### SPREAD
  
  # if we got spread correct and our return
  mutate(spread_correct = ifelse(pred_t1_cover == actual_t1_cover, 1, 0),
         spread_winnings = ifelse(spread_correct == 1 & actual_t1_cover == 1 & -110 > 0, 
                                  1 + abs(-110)/100,
                            ifelse(spread_correct == 1 & actual_t1_cover == 1,
                                   1 + 100/abs(-110),
                            ifelse(spread_correct == 1 &  -110 > 0, 
                                  1 + abs(-110)/100,
                            ifelse(spread_correct == 1,
                                   1 + 100/abs(-110),
                            0))))) %>% 
  # average bettor's spread returns
  mutate(naive_spread_winnings = ifelse(actual_t1_cover == 1 & -110 > 0, 
                                  (1 + abs(-110)/100)/2,
                            ifelse(actual_t1_cover == 1,
                                   (1 + 100/abs(-110))/2,
                            ifelse(-110 > 0, 
                                  (1 + abs(-110)/100)/2, 
                            (1 + 100/abs(-110))/2
                            )))) %>%
  #confidence in our prediction above 50%
  mutate(cover_confidence = abs(pred_t1_cp - .5)) %>% 
  
  
  
  
  
  ### MONEYLINE
  
  # convert win prob to ml value
  mutate(t1_ml_prob = ifelse(t1_moneyline > 0, 100 / (t1_moneyline + 100), -t1_moneyline / (-t1_moneyline + 100)),
         t2_ml_prob = ifelse(t2_moneyline > 0, 100 / (t2_moneyline + 100), -t2_moneyline / (-t2_moneyline + 100))) %>% 
  # how much value is there
  mutate(pred_t1_ml_value = pred_t1_wp - t1_ml_prob,
         pred_t2_ml_value = (1 - pred_t1_wp) - t2_ml_prob
         ) %>% 
  # should we bet on either (is value positive?)
  mutate(pred_t1_ml_bet = ifelse(pred_t1_ml_value > pred_t2_ml_value & pred_t1_ml_value > 0, 1, 0),
         pred_t2_ml_bet = ifelse(pred_t2_ml_value > pred_t1_ml_value & pred_t2_ml_value > 0, 1, 0)
       ) %>% 
  # if we got correct, our return
  mutate(ml_correct = ifelse((pred_t1_ml_bet == 1 & actual_t1_win == 1) | (pred_t2_ml_bet == 1 & actual_t1_win == 0), 1, 0),
         ml_winnings = ifelse(ml_correct == 1 & actual_t1_win == 1 & t1_moneyline > 0, 
                                  1 + abs(t1_moneyline)/100,
                            ifelse(ml_correct == 1 & actual_t1_win == 1,
                                   1 + 100/abs(t1_moneyline),
                            ifelse(ml_correct == 1 &  t2_moneyline > 0, 
                                  1 + abs(t2_moneyline)/100,
                            ifelse(ml_correct == 1,
                                   1 + 100/abs(t2_moneyline),
                            ifelse(pred_t1_ml_bet + pred_t2_ml_bet == 0, 1,
                                   0)))))) %>% 
      # average bettor's ml returns
  mutate(naive_ml_winnings = ifelse(actual_t1_win == 1 & t1_moneyline > 0, 
                                  (1 + abs(t1_moneyline)/100)/2,
                            ifelse(actual_t1_win == 1,
                                   (1 + 100/abs(t1_moneyline))/2,
                            ifelse(t2_moneyline > 0, 
                                  (1 + abs(t2_moneyline)/100)/2, 
                            (1 + 100/abs(t2_moneyline))/2
                            )))) %>%
    # how much we predicted the book was off (best value)
    mutate(ml_value = ifelse(pred_t1_ml_value > pred_t2_ml_value, pred_t1_ml_value, pred_t2_ml_value)) %>% 
  
  
  
  
  
  ### OVER/UNDER
  
  
  # cols for if predicted and actual results covered for over/under
  mutate(ou_correct = ifelse(pred_over == actual_over, 1, 0),
         ou_winnings = ifelse(ou_correct == 1 & actual_over == 1 & -110 > 0, 
                                  1 + abs(-110)/100,
                            ifelse(ou_correct == 1 & actual_over == 1,
                                   1 + 100/abs(-110),
                            ifelse(ou_correct == 1 &  -110 > 0, 
                                  1 + abs(-110)/100,
                            ifelse(ou_correct == 1,
                                   1 + 100/abs(-110),
                            0))))) %>% 
  # average bettor's over/under returns
  mutate(naive_ou_winnings = ifelse(actual_over == 1 & -110 > 0, 
                                  (1 + abs(-110)/100)/2,
                            ifelse(actual_over == 1,
                                   (1 + 100/abs(-110))/2,
                            ifelse(-110 > 0, 
                                  (1 + abs(-110)/100)/2, 
                            (1 + 100/abs(-110))/2
                            )))) %>%
  # confidence in our prediction above 50%
  mutate(ou_confidence = abs(pred_op - .5))

  
```




# Write out

```{r}
# save out most just this iteration
write.csv(winnings_calc, paste0("winnings_calc_saves/winnings_calc", current_season, min(wk_range), "to", max(wk_range), ".csv"))
```


```{r}

# bring in current winning calc
winnings_calc_current = read.csv("winnings_calc_current.csv")[-1] %>% 
  filter(season != current_season & !(week %in% wk_range))

# rbind this week's
winnings_calc_final = rbind(winnings_calc_current, winnings_calc)

```


```{r}

# write out new winnings calc current
write.csv(winnings_calc_final, "winnings_calc_current.csv")

```



### Find winning values overall

```{r}

# spread
sum(winnings_calc_final$spread_winnings) / length(winnings_calc_final$spread_winnings)
sum(winnings_calc_final$naive_spread_winnings) / length(winnings_calc_final$spread_winnings)


# ml
sum(winnings_calc_final$ml_winnings, na.rm = TRUE) / length((winnings_calc_final %>% filter(!is.na(ml_winnings)))$ml_winnings)
sum(winnings_calc_final$naive_ml_winnings, na.rm = TRUE) / length((winnings_calc_final %>% filter(!is.na(ml_winnings)))$ml_winnings)


# ou
sum(winnings_calc_final$ou_winnings) / length(winnings_calc_final$ou_winnings)
sum(winnings_calc_final$naive_ou_winnings) / length(winnings_calc_final$ou_winnings)
  
```

<br>

## Load in Team Logos and Current Rankings


```{r}

# load team info
team_info = cfbd_team_info()

# select cols
team_info = team_info %>% 
  select(school, color, logo)

# write truncated result out
write.csv(team_info, "team_info.csv")
#team_info = read.csv("team_info.csv")[,-1]
```

```{r}

# current rankings (use AP until cfbp)
current_rankings = (cfbd_rankings(year=current_season, week = current_week) %>% filter(poll == "AP Top 25") %>% select(school, rank))[1:12,]
write.csv(current_rankings, "this_week_ranks.csv")

```



<br>

## Create Theoretical Games


### Find most recent stats


```{r}

# params for the book models
parameters_book = list(eta = .03,
              max.depth = 4, 
              min_child_weight = 6,
              gamma = .04, 
              subsample = .8,
              colsample_bytree = .9,
              
              
              nrounds = 185 , 
              early_stopping_rounds = 15, 
              
              verbose = 0, 
              nthread = 8,
              
              objective = "reg:squarederror",
              eval_metric = "rmse")




```


```{r}


# create fake rows, take the most recent week of data for each team
theor_prepped_omit = model_prepped_omit %>%
  filter(season == current_season) %>% 
  arrange(desc(week)) %>% 
  group_by(t1_team) %>% 
  mutate(desc_order = row_number()) %>% 
  filter(desc_order == 1) %>% 
  select(-c(desc_order)) %>% 
  ungroup()



# get rid of team 2 and betting stuff
theor_prepped_omit = theor_prepped_omit %>% 
  mutate(across(all_of(grep("t2", names(theor_prepped_omit))), ~ NA))

theor_prepped_omit = theor_prepped_omit %>% 
  mutate(across(all_of(grep("_odds", names(theor_prepped_omit))), ~ NA))

theor_prepped_omit = theor_prepped_omit %>% 
  mutate(across(all_of(grep("_val", names(theor_prepped_omit))), ~ NA))


# make non-feature cols NA
theor_prepped_omit = theor_prepped_omit %>% 
  mutate(across(all_of(c("t1_book_spread", "game_id", "t1_points", "t2_points", "total_points", "t1_win", "t1_point_diff", "conference_game")), ~ NA))


  

```


<br>

### Create fake games

```{r}
source("cfb_app_helpers.r")
```


```{r}


# create t1 and t2 dfs
theor_prepped_t1 = theor_prepped_omit %>% 
   select(contains("t1"))

theor_prepped_t2 = theor_prepped_omit %>% 
   select(-c(t1_book_spread)) %>% 
   select(contains("t1"))

names(theor_prepped_t2) <- gsub("t1", "t2", names(theor_prepped_t2))




# create fake games thru combinations
teams1 = unique(theor_prepped_omit$t1_team)
teams2 = unique(theor_prepped_omit$t1_team)

combinations <- expand.grid(t1_team = teams1, t2_team = teams2) %>% 
  filter(t1_team != t2_team)





# create fake game df
theor_prepped_frame = theor_prepped_omit %>% filter(is.na(t1_team))
theor_prepped_start = as.data.frame(matrix(NA, nrow = dim(combinations)[1]), ncol = 1)
theor_prepped_start$t1_team = combinations$t1_team
theor_prepped_start$t2_team = combinations$t2_team


# join in stats
theor_prepped_start = theor_prepped_start %>% 
  left_join(theor_prepped_t1, by = "t1_team") %>% 
  left_join(theor_prepped_t2, by = "t2_team")


# modify structure of cols
theor_prepped_frame$t2_team = as.character(theor_prepped_frame$t2_team)
theor_prepped_frame$t2_conference = as.character(theor_prepped_frame$t2_conference)
theor_prepped_home = bind_rows(theor_prepped_frame, theor_prepped_start) %>% 
    mutate(week = current_week,
         completed = FALSE,
         season = current_season,
         t1_home = 1,
         neutral_site = 0)

theor_prepped_away = theor_prepped_home %>% 
  mutate(t1_home = 0)

theor_prepped_neutral = theor_prepped_away %>% 
  mutate(neutral_site = 1)



# bind h/a/n together
theor_prepped_joined = bind_rows(theor_prepped_home, theor_prepped_away, theor_prepped_neutral)



# predict and add book variables for model
book_spread_model = book_function("t1_book_spread", theor_prepped_joined)
book_over_under_model = book_function("book_over_under", theor_prepped_joined)

theor_prepped_joined$book_over_under = book_over_under_model
theor_prepped_joined$t1_book_spread = book_spread_model





```

```{r}

# load in most recent pd model info
theor_model = xgb.load("most_recent_t1_win_model.model")
theor_vars = read.csv("most_recent_t1_winmodel_var_list.csv")[,2]


# create test matrix for theoretical games
theor_test = theor_prepped_joined %>% select(theor_vars, t1_home, neutral_site, t1_team, t2_team, t1_conference, t2_conference)
num_predictors_theor = length(theor_vars)

test_matrix_theor = xgb.DMatrix(data = as.matrix(theor_test[,1:num_predictors_theor]))



# predict
preds = predict(theor_model, test_matrix_theor)
pred_dat_final_theor = cbind.data.frame(pred_t1_wp = preds, t1_team = theor_test$t1_team, t2_team = theor_test$t2_team, t1_home = theor_test$t1_home, neutral_site = theor_test$neutral_site, t1_conference = theor_test$t1_conference, t2_conference = theor_test$t2_conference) 
  




# combine preds into df
pred_dat_final_theor = pred_dat_final_theor %>% 
  mutate(id_max = ifelse(t1_home ==1, t1_team, ifelse(neutral_site == 1, pmax(pred_dat_final_theor$t1_team, pred_dat_final_theor$t2_team), t2_team))) %>% 
    mutate(id_min = ifelse(t1_home ==1, t2_team, ifelse(neutral_site == 1, pmin(pred_dat_final_theor$t1_team, pred_dat_final_theor$t2_team), t1_team)))

pred_dat_final_theor$game_id = 1:dim(pred_dat_final_theor)[1]


merge_preds_theor = pred_dat_final_theor %>% 
  mutate(pred_t1_wp = ifelse(t1_team == id_max,pred_t1_wp, 
                                     (1-pred_t1_wp))) %>% 
  group_by(game_id) %>% 
  summarise(pred_t1_wp = mean(pred_t1_wp)) 


pred_dat_final_theor = pred_dat_final_theor %>% 
  filter(t1_team == id_max) %>% 
  select(-c(pred_t1_wp)) %>% 
  left_join(merge_preds_theor, by = c("game_id"))%>% 
  mutate(pred_t1_wp = round(pred_t1_wp,4)) %>% 
  select(-c(id_min, id_max))





# duplicate rows and flip one for easier aggregation by team
pred_dat_final_theor2 = pred_dat_final_theor %>% 
  mutate(pred_t1_wp = (1-pred_t1_wp)) %>% 
  mutate(t1_home = ifelse(neutral_site == 1, 0, ifelse(t1_home == 1, 0, 1))) %>% 
  mutate(
    across(
      .cols = c("t1_team", "t2_team", "t1_conference", "t2_conference"),
      .fns = ~ .x, .names = "{.col}_copy"
    )
  ) %>%
  mutate(
    t1_conference = t2_conference_copy,
    t2_conference = t1_conference_copy,
    t1_team = t2_team_copy,
    t2_team = t1_team_copy,
    ) %>%
  select(-ends_with("_copy"))



# muatate some info, join team info stuff
pred_dat_final_theor = bind_rows(pred_dat_final_theor, pred_dat_final_theor2) %>% 
  mutate(t1_win = ifelse(pred_t1_wp > .5, 1, 0),
         conference_game = ifelse(t1_conference == t2_conference, 1, 0),
         week = current_week) %>% 
  left_join(team_info %>% rename(t1_team = school, t1_color = color, t1_logo = logo), by = "t1_team") %>% 
  left_join(team_info %>% rename(t2_team = school, t2_color = color, t2_logo = logo), by = "t2_team") %>%
  mutate(winning_logo = ifelse(pred_t1_wp >.5, t1_logo, t2_logo),
         losing_logo = ifelse(pred_t1_wp <=.5, t1_logo, t2_logo),
         winning_color = ifelse(pred_t1_wp >.5, t1_color, t2_color),
         losing_logo = ifelse(pred_t1_wp <=.5, t1_logo, t2_logo),
         winning_team = ifelse(t1_win == 1, t1_team, t2_team),
         losing_team = ifelse(t1_win == 0, t1_team, t2_team))



```

```{r}

# aggregate by team

theor_agg_conf = pred_dat_final_theor %>% filter(conference_game == 1) %>% group_by(t1_team) %>% summarise(win_perc_conf = round(mean(pred_t1_wp)*100,2)) %>% mutate(conf_record = paste0({round(.12*win_perc_conf,0)},"-",{12-round(.12*win_perc_conf,0)})) %>% arrange(desc(win_perc_conf)) 

theor_agg = pred_dat_final_theor %>% group_by(t1_team, t1_conference) %>% summarise(win_perc = round(mean(pred_t1_wp)*100,2)) %>% mutate(record = paste0({round(.12*win_perc,0)},"-",{12-round(.12*win_perc,0)})) %>%   arrange(desc(win_perc)) %>% left_join(theor_agg_conf, by = "t1_team") %>% ungroup %>%  mutate(Rank = row_number()) %>% group_by(t1_conference) %>% mutate(`Conf Rank` = row_number()) %>% ungroup() %>% 
  rename(Team = t1_team,
         Conf = t1_conference,
         `Pred Win%` = win_perc,
         `Pred Record` = record,
         `Pred Conf Win%` = win_perc_conf,
         `Pred Conf Record` = conf_record)




```





```{r}
# write theoretical data out

# aggregated for power rankings
write.csv(theor_agg, "theoretical_agg.csv")

# prepped data for game predictor
write.csv(pred_dat_final_theor, "theor_prepped.csv")

# save this weeks prankings to backup folder
write.csv(theor_agg, paste0("prankings_saves/theor_agg_", current_season, current_week, ".csv"))

```


<br>






